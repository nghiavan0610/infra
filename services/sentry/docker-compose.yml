# =============================================================================
# Sentry - Self-Hosted Error Tracking
# =============================================================================
# Production-ready error tracking and performance monitoring
#
# Prerequisites:
#   - PostgreSQL running (uses shared postgres)
#   - Redis running (uses shared redis)
#
# Usage:
#   docker network create traefik-public  # If not using setup-all.sh
#   docker compose up -d
#   docker compose exec sentry sentry upgrade  # First time only
#
# Access: http://localhost:9000
# =============================================================================

services:
  sentry:
    image: sentry:24.1.0
    container_name: sentry
    restart: unless-stopped
    environment:
      SENTRY_SECRET_KEY: ${SENTRY_SECRET_KEY}
      SENTRY_POSTGRES_HOST: ${POSTGRES_HOST:-host.docker.internal}
      SENTRY_POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      SENTRY_DB_NAME: ${SENTRY_DB_NAME:-sentry}
      SENTRY_DB_USER: ${POSTGRES_USER:-postgres}
      SENTRY_DB_PASSWORD: ${POSTGRES_PASSWORD}
      SENTRY_REDIS_HOST: ${REDIS_HOST:-host.docker.internal}
      SENTRY_REDIS_PORT: ${REDIS_PORT:-6379}
      SENTRY_REDIS_PASSWORD: ${REDIS_PASSWORD}
      SENTRY_EMAIL_HOST: ${SMTP_HOST:-mailpit}
      SENTRY_EMAIL_PORT: ${SMTP_PORT:-1025}
      SENTRY_EMAIL_USER: ${SMTP_USER:-}
      SENTRY_EMAIL_PASSWORD: ${SMTP_PASSWORD:-}
      SENTRY_EMAIL_USE_TLS: ${SMTP_USE_TLS:-false}
      SENTRY_SERVER_EMAIL: ${SENTRY_EMAIL:-sentry@localhost}
    ports:
      - "127.0.0.1:${SENTRY_PORT:-9000}:9000"
    volumes:
      - sentry_data:/var/lib/sentry/files
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
    healthcheck:
      test: ["CMD", "sentry", "--help"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    # -------------------------------------------------------------------------
    # Traefik Configuration (uncomment labels to enable)
    # -------------------------------------------------------------------------
    # labels:
    #   - "traefik.enable=true"
    #   - "traefik.http.routers.sentry.rule=Host(`${SENTRY_DOMAIN:-sentry.example.com}`)"
    #   - "traefik.http.routers.sentry.entrypoints=websecure"
    #   - "traefik.http.routers.sentry.tls.certresolver=letsencrypt"
    #   - "traefik.http.services.sentry.loadbalancer.server.port=9000"
    networks:
      - traefik-public
    depends_on:
      - sentry-cron
      - sentry-worker

  sentry-cron:
    image: sentry:24.1.0
    container_name: sentry-cron
    restart: unless-stopped
    command: run cron
    environment:
      SENTRY_SECRET_KEY: ${SENTRY_SECRET_KEY}
      SENTRY_POSTGRES_HOST: ${POSTGRES_HOST:-host.docker.internal}
      SENTRY_POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      SENTRY_DB_NAME: ${SENTRY_DB_NAME:-sentry}
      SENTRY_DB_USER: ${POSTGRES_USER:-postgres}
      SENTRY_DB_PASSWORD: ${POSTGRES_PASSWORD}
      SENTRY_REDIS_HOST: ${REDIS_HOST:-host.docker.internal}
      SENTRY_REDIS_PORT: ${REDIS_PORT:-6379}
      SENTRY_REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes:
      - sentry_data:/var/lib/sentry/files
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - traefik-public

  sentry-worker:
    image: sentry:24.1.0
    container_name: sentry-worker
    restart: unless-stopped
    command: run worker
    environment:
      SENTRY_SECRET_KEY: ${SENTRY_SECRET_KEY}
      SENTRY_POSTGRES_HOST: ${POSTGRES_HOST:-host.docker.internal}
      SENTRY_POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      SENTRY_DB_NAME: ${SENTRY_DB_NAME:-sentry}
      SENTRY_DB_USER: ${POSTGRES_USER:-postgres}
      SENTRY_DB_PASSWORD: ${POSTGRES_PASSWORD}
      SENTRY_REDIS_HOST: ${REDIS_HOST:-host.docker.internal}
      SENTRY_REDIS_PORT: ${REDIS_PORT:-6379}
      SENTRY_REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes:
      - sentry_data:/var/lib/sentry/files
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1G
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - traefik-public

# =============================================================================
# Volumes
# =============================================================================
volumes:
  sentry_data:
    driver: local
    name: sentry_data

# =============================================================================
# Networks
# =============================================================================
networks:
  traefik-public:
    external: true
    name: traefik-public
