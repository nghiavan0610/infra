# =============================================================================
# Plausible Analytics - Privacy-friendly web analytics
# =============================================================================
# Uses shared PostgreSQL and ClickHouse services
#
# Prerequisites:
#   - PostgreSQL running (shared postgres)
#   - ClickHouse running (shared clickhouse)
#
# Usage:
#   docker compose up -d
#
# Access: http://localhost:8003
# =============================================================================

services:
  plausible:
    image: ghcr.io/plausible/community-edition:v2.1.1
    container_name: plausible
    restart: unless-stopped
    command: sh -c "sleep 10 && /entrypoint.sh db createdb && /entrypoint.sh db migrate && /entrypoint.sh run"
    environment:
      - BASE_URL=${PLAUSIBLE_BASE_URL:-http://localhost:8000}
      - SECRET_KEY_BASE=${PLAUSIBLE_SECRET_KEY}
      - TOTP_VAULT_KEY=${PLAUSIBLE_TOTP_KEY}
      # Shared PostgreSQL
      - DATABASE_URL=postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@${POSTGRES_HOST:-postgres}:${POSTGRES_PORT:-5432}/${PLAUSIBLE_DB_NAME:-plausible}
      # Shared ClickHouse
      - CLICKHOUSE_DATABASE_URL=http://${CLICKHOUSE_HOST:-clickhouse}:${CLICKHOUSE_HTTP_PORT:-8123}/${PLAUSIBLE_CLICKHOUSE_DB:-plausible_events}
      # Email (optional)
      - MAILER_EMAIL=${PLAUSIBLE_MAILER_EMAIL:-}
      - SMTP_HOST_ADDR=${PLAUSIBLE_SMTP_HOST:-}
      - SMTP_HOST_PORT=${PLAUSIBLE_SMTP_PORT:-}
      # Disable registration after setup
      - DISABLE_REGISTRATION=${PLAUSIBLE_DISABLE_REGISTRATION:-false}
    ports:
      - "${PLAUSIBLE_PORT:-8003}:8000"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    networks:
      - infra
    labels:
      # Traefik configuration (uncomment to expose via reverse proxy)
      # - "traefik.enable=true"
      # - "traefik.http.routers.plausible.rule=Host(`${PLAUSIBLE_DOMAIN}`)"
      # - "traefik.http.routers.plausible.entrypoints=websecure"
      # - "traefik.http.routers.plausible.tls.certresolver=letsencrypt"
      # - "traefik.http.services.plausible.loadbalancer.server.port=8000"
      - "traefik.enable=false"

networks:
  infra:
    external: true
