# =============================================================================
# NATS Server Configuration - Production Optimized
# =============================================================================

# -----------------------------------------------------------------------------
# Network Configuration
# -----------------------------------------------------------------------------
host: "0.0.0.0"
port: 4222

# HTTP Monitoring endpoint
http_port: 8222

# Server identification
server_name: "nats-prod-1"

# -----------------------------------------------------------------------------
# Authentication
# -----------------------------------------------------------------------------
include "auth.conf"

# -----------------------------------------------------------------------------
# Connection Limits
# -----------------------------------------------------------------------------
max_connections: 10000
max_control_line: 4KB
max_payload: 1MB
max_pending: 64MB

# Subscriptions
max_subscriptions: 0  # 0 = unlimited

# -----------------------------------------------------------------------------
# Timeouts & Keep-alive
# -----------------------------------------------------------------------------
ping_interval: "20s"
ping_max: 3
write_deadline: "10s"

# Authentication timeout (moved inside authorization block if needed)
# auth_timeout: 2

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------
logtime: true
log_file: "/var/log/nats/nats.log"
log_size_limit: 100MB

# Debug options (disable in production)
debug: false
trace: false
logtime_utc: true

# Limit traced message size
max_traced_msg_len: 256

# Syslog (optional)
# syslog: true
# remote_syslog: "udp://logs.example.com:514"

# -----------------------------------------------------------------------------
# JetStream Configuration
# -----------------------------------------------------------------------------
jetstream {
    # Storage directory
    store_dir: "/data/jetstream"

    # Memory storage limit (for memory-based streams)
    max_memory_store: 1GB

    # File storage limit (for file-based streams)
    max_file_store: 50GB

    # Sync to disk interval
    # Shorter = safer (less data loss on crash)
    # Longer = faster (better throughput)
    # 1s for critical data, 10s-60s for less critical
    sync_interval: "1s"

    # Domain for multi-cluster setups
    domain: "production"

    # Encryption cipher (chachapoly is faster on ARM/non-AES-NI)
    cipher: "chachapoly"

    # Compression - handled at stream level, not server level
    # compress: true

    # Unique tag for this server (useful for multi-node)
    # unique_tag: "az:us-east-1a"
}

# -----------------------------------------------------------------------------
# Performance Tuning
# -----------------------------------------------------------------------------
# Disable no_advertise if clients need to discover cluster nodes
# no_advertise: true

# Disable echo for performance (clients won't receive their own messages)
# no_echo: true

# Connection coalescing for better throughput
# write_deadline: "2s"

# -----------------------------------------------------------------------------
# Cluster Configuration (for High Availability)
# -----------------------------------------------------------------------------
# Uncomment for multi-node cluster setup
# cluster {
#     name: "nats-cluster"
#     host: "0.0.0.0"
#     port: 6222
#
#     # Cluster authentication
#     authorization {
#         user: "cluster_user"
#         password: $NATS_CLUSTER_PASS
#         timeout: 2
#     }
#
#     # Routes to other cluster nodes
#     routes = [
#         nats://cluster_user:$NATS_CLUSTER_PASS@nats-1:6222
#         nats://cluster_user:$NATS_CLUSTER_PASS@nats-2:6222
#         nats://cluster_user:$NATS_CLUSTER_PASS@nats-3:6222
#     ]
#
#     # Cluster optimizations
#     pool_size: 3
#     compression: {
#         mode: s2_auto
#     }
# }

# -----------------------------------------------------------------------------
# TLS Configuration (recommended for production)
# -----------------------------------------------------------------------------
# tls {
#     cert_file: "/etc/nats/certs/server.crt"
#     key_file: "/etc/nats/certs/server.key"
#     ca_file: "/etc/nats/certs/ca.crt"
#
#     # Require client certificates (mTLS)
#     verify: true
#
#     # TLS timeout
#     timeout: 2
#
#     # Minimum TLS version
#     min_version: "1.2"
#
#     # Cipher suites (optional - defaults are secure)
#     # cipher_suites: [
#     #     "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384",
#     #     "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"
#     # ]
# }

# -----------------------------------------------------------------------------
# WebSocket Configuration (for browser clients)
# -----------------------------------------------------------------------------
# websocket {
#     host: "0.0.0.0"
#     port: 9222
#     no_tls: false
#
#     # TLS for WebSocket
#     tls {
#         cert_file: "/etc/nats/certs/server.crt"
#         key_file: "/etc/nats/certs/server.key"
#     }
#
#     # Compression
#     compression: true
#
#     # Same origin policy
#     same_origin: false
#     allowed_origins: ["https://app.example.com"]
# }

# -----------------------------------------------------------------------------
# MQTT Configuration (for IoT devices)
# -----------------------------------------------------------------------------
# mqtt {
#     host: "0.0.0.0"
#     port: 1883
#
#     # TLS for MQTT (port 8883)
#     # tls {
#     #     cert_file: "/etc/nats/certs/server.crt"
#     #     key_file: "/etc/nats/certs/server.key"
#     # }
#
#     # Ack wait for QoS > 0
#     ack_wait: "1m"
#
#     # Max ack pending
#     max_ack_pending: 100
# }

# -----------------------------------------------------------------------------
# Leaf Node Configuration (for edge deployments)
# -----------------------------------------------------------------------------
# leafnodes {
#     host: "0.0.0.0"
#     port: 7422
#
#     authorization {
#         user: "leaf_user"
#         password: $NATS_LEAF_PASS
#     }
#
#     # TLS
#     # tls {
#     #     cert_file: "/etc/nats/certs/server.crt"
#     #     key_file: "/etc/nats/certs/server.key"
#     # }
# }

# -----------------------------------------------------------------------------
# Operator Mode (for production-grade security)
# -----------------------------------------------------------------------------
# Use NATS account resolver with JWT-based authentication
# operator: "/etc/nats/operator.jwt"
# resolver: {
#     type: full
#     dir: "/data/jwt"
#     allow_delete: false
#     interval: "2m"
# }
