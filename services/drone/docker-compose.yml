services:
  drone:
    image: drone/drone:2
    container_name: drone
    restart: unless-stopped
    environment:
      # Server configuration
      - DRONE_SERVER_HOST=${DRONE_SERVER_HOST:-localhost}
      - DRONE_SERVER_PROTO=${DRONE_SERVER_PROTO:-http}
      - DRONE_RPC_SECRET=${DRONE_RPC_SECRET}

      # Gitea integration (default)
      - DRONE_GITEA_SERVER=${DRONE_GITEA_SERVER:-http://gitea:3000}
      - DRONE_GITEA_CLIENT_ID=${DRONE_GITEA_CLIENT_ID}
      - DRONE_GITEA_CLIENT_SECRET=${DRONE_GITEA_CLIENT_SECRET}

      # GitHub integration (alternative)
      # - DRONE_GITHUB_SERVER=https://github.com
      # - DRONE_GITHUB_CLIENT_ID=${DRONE_GITHUB_CLIENT_ID}
      # - DRONE_GITHUB_CLIENT_SECRET=${DRONE_GITHUB_CLIENT_SECRET}

      # GitLab integration (alternative)
      # - DRONE_GITLAB_SERVER=https://gitlab.com
      # - DRONE_GITLAB_CLIENT_ID=${DRONE_GITLAB_CLIENT_ID}
      # - DRONE_GITLAB_CLIENT_SECRET=${DRONE_GITLAB_CLIENT_SECRET}

      # Database
      - DRONE_DATABASE_DRIVER=sqlite3
      - DRONE_DATABASE_DATASOURCE=/data/database.sqlite

      # User settings
      - DRONE_USER_CREATE=username:${DRONE_ADMIN_USER:-admin},admin:true
      - DRONE_USER_FILTER=${DRONE_USER_FILTER:-}

      # Logging
      - DRONE_LOGS_DEBUG=${DRONE_DEBUG:-false}
      - DRONE_LOGS_TRACE=${DRONE_TRACE:-false}
    ports:
      - "${DRONE_PORT:-8082}:80"
    volumes:
      - drone_data:/data
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:80/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - infra
      - traefik-public
    labels:
      # Traefik configuration (uncomment to expose via reverse proxy)
      # - "traefik.enable=true"
      # - "traefik.http.routers.drone.rule=Host(`${DRONE_DOMAIN}`)"
      # - "traefik.http.routers.drone.entrypoints=websecure"
      # - "traefik.http.routers.drone.tls.certresolver=letsencrypt"
      # - "traefik.http.services.drone.loadbalancer.server.port=80"
      - "traefik.enable=false"

  drone-runner:
    image: drone/drone-runner-docker:1
    container_name: drone-runner
    restart: unless-stopped
    environment:
      - DRONE_RPC_PROTO=${DRONE_SERVER_PROTO:-http}
      - DRONE_RPC_HOST=drone
      - DRONE_RPC_SECRET=${DRONE_RPC_SECRET}
      - DRONE_RUNNER_NAME=${DRONE_RUNNER_NAME:-docker-runner}
      - DRONE_RUNNER_CAPACITY=${DRONE_RUNNER_CAPACITY:-2}
      - DRONE_RUNNER_NETWORKS=infra
      - DRONE_DEBUG=${DRONE_DEBUG:-false}
      - DRONE_TRACE=${DRONE_TRACE:-false}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      drone:
        condition: service_healthy
    networks:
      - infra

volumes:
  drone_data:

networks:
  infra:
    external: true
  traefik-public:
    external: true
