# =============================================================================
# Traefik Alerting Rules
# =============================================================================
# Alerts for Traefik reverse proxy/load balancer monitoring.
# Requires: Traefik with metrics enabled
#
# Enable in traefik.yml:
#   metrics:
#     prometheus:
#       entryPoint: metrics
# =============================================================================

groups:
  - name: traefik
    rules:
      # =========================================================================
      # Availability
      # =========================================================================
      - alert: TraefikDown
        expr: up{job="traefik"} == 0
        for: 1m
        labels:
          severity: critical
          category: traefik
        annotations:
          summary: "Traefik is down"
          description: "Traefik instance {{ $labels.instance }} has been down for more than 1 minute."

      # =========================================================================
      # Backend/Service Health
      # =========================================================================
      - alert: TraefikServiceDown
        expr: traefik_service_server_up == 0
        for: 2m
        labels:
          severity: critical
          category: traefik
        annotations:
          summary: "Traefik backend service is down"
          description: "Service {{ $labels.service }} server {{ $labels.url }} is down."

      - alert: TraefikNoActiveBackends
        expr: |
          count by (service) (traefik_service_server_up == 1) == 0
        for: 2m
        labels:
          severity: critical
          category: traefik
        annotations:
          summary: "Traefik service has no healthy backends"
          description: "Service {{ $labels.service }} has no healthy backend servers."

      - alert: TraefikBackendsDegraded
        expr: |
          count by (service) (traefik_service_server_up == 0) > 0
          and count by (service) (traefik_service_server_up == 1) > 0
        for: 5m
        labels:
          severity: warning
          category: traefik
        annotations:
          summary: "Traefik service has unhealthy backends"
          description: "Service {{ $labels.service }} has some unhealthy backend servers."

      # =========================================================================
      # HTTP Errors
      # =========================================================================
      - alert: TraefikHighHttp4xxErrorRate
        expr: |
          sum(rate(traefik_service_requests_total{code=~"4.."}[5m])) by (service)
          /
          sum(rate(traefik_service_requests_total[5m])) by (service)
          * 100 > 10
        for: 5m
        labels:
          severity: warning
          category: traefik
        annotations:
          summary: "Traefik high 4xx error rate"
          description: "Service {{ $labels.service }} has {{ printf \"%.1f\" $value }}% 4xx error rate."

      - alert: TraefikHighHttp5xxErrorRate
        expr: |
          sum(rate(traefik_service_requests_total{code=~"5.."}[5m])) by (service)
          /
          sum(rate(traefik_service_requests_total[5m])) by (service)
          * 100 > 5
        for: 5m
        labels:
          severity: critical
          category: traefik
        annotations:
          summary: "Traefik high 5xx error rate"
          description: "Service {{ $labels.service }} has {{ printf \"%.1f\" $value }}% 5xx error rate. Backend may be failing."

      - alert: TraefikHttp5xxSpike
        expr: |
          sum(rate(traefik_service_requests_total{code=~"5.."}[1m])) by (service) > 10
        for: 2m
        labels:
          severity: critical
          category: traefik
        annotations:
          summary: "Traefik 5xx error spike"
          description: "Service {{ $labels.service }} has {{ printf \"%.0f\" $value }} 5xx errors/sec."

      # =========================================================================
      # Latency
      # =========================================================================
      - alert: TraefikHighLatency
        expr: |
          histogram_quantile(0.95, sum(rate(traefik_service_request_duration_seconds_bucket[5m])) by (le, service)) > 1
        for: 5m
        labels:
          severity: warning
          category: traefik
        annotations:
          summary: "Traefik high latency"
          description: "Service {{ $labels.service }} P95 latency is {{ printf \"%.2f\" $value }}s (threshold: 1s)."

      - alert: TraefikLatencyCritical
        expr: |
          histogram_quantile(0.95, sum(rate(traefik_service_request_duration_seconds_bucket[5m])) by (le, service)) > 5
        for: 2m
        labels:
          severity: critical
          category: traefik
        annotations:
          summary: "Traefik latency critical"
          description: "Service {{ $labels.service }} P95 latency is {{ printf \"%.2f\" $value }}s. Backend may be overloaded."

      # =========================================================================
      # Request Rate
      # =========================================================================
      - alert: TraefikHighRequestRate
        expr: |
          sum(rate(traefik_service_requests_total[5m])) by (service) > 10000
        for: 5m
        labels:
          severity: warning
          category: traefik
        annotations:
          summary: "Traefik high request rate"
          description: "Service {{ $labels.service }} is receiving {{ printf \"%.0f\" $value }} requests/sec."

      - alert: TraefikNoRequests
        expr: |
          sum(rate(traefik_service_requests_total[15m])) by (service) == 0
          and sum(traefik_service_requests_total) by (service) > 0
        for: 15m
        labels:
          severity: warning
          category: traefik
        annotations:
          summary: "Traefik service receiving no requests"
          description: "Service {{ $labels.service }} has not received any requests in 15 minutes."

      # =========================================================================
      # Entrypoints
      # =========================================================================
      - alert: TraefikEntrypointDown
        expr: |
          sum(rate(traefik_entrypoint_requests_total[5m])) by (entrypoint) == 0
          and sum(traefik_entrypoint_requests_total) by (entrypoint) > 0
        for: 5m
        labels:
          severity: warning
          category: traefik
        annotations:
          summary: "Traefik entrypoint receiving no traffic"
          description: "Entrypoint {{ $labels.entrypoint }} has not received any requests in 5 minutes."

      # =========================================================================
      # TLS/Certificates
      # =========================================================================
      - alert: TraefikTLSCertExpiringSoon
        expr: |
          (traefik_tls_certs_not_after - time()) / 86400 < 14
        for: 1h
        labels:
          severity: warning
          category: traefik
        annotations:
          summary: "TLS certificate expiring soon"
          description: "TLS certificate for {{ $labels.cn }} expires in {{ printf \"%.0f\" $value }} days."

      - alert: TraefikTLSCertExpiryCritical
        expr: |
          (traefik_tls_certs_not_after - time()) / 86400 < 7
        for: 1h
        labels:
          severity: critical
          category: traefik
        annotations:
          summary: "TLS certificate expiring very soon"
          description: "TLS certificate for {{ $labels.cn }} expires in {{ printf \"%.0f\" $value }} days. Immediate renewal required."

      # =========================================================================
      # Open Connections
      # =========================================================================
      - alert: TraefikOpenConnectionsHigh
        expr: traefik_entrypoint_open_connections > 10000
        for: 5m
        labels:
          severity: warning
          category: traefik
        annotations:
          summary: "Traefik high open connections"
          description: "Entrypoint {{ $labels.entrypoint }} has {{ $value }} open connections."
