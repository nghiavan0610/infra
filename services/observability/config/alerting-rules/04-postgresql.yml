# =============================================================================
# PostgreSQL Alerts
# =============================================================================
# Toggle: ALERTS_POSTGRESQL=true in .env
# Disable: Rename to 04-postgresql.yml.disabled

groups:
  - name: postgresql
    interval: 30s
    rules:
      # PostgreSQL Down
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
          service: postgresql
        annotations:
          summary: "PostgreSQL is down"
          description: "PostgreSQL instance {{ $labels.instance }} has been down for more than 1 minute."

      # PostgreSQL Too Many Connections
      - alert: PostgreSQLTooManyConnections
        expr: (pg_stat_activity_count / pg_settings_max_connections) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: postgresql
        annotations:
          summary: "PostgreSQL too many connections"
          description: "PostgreSQL {{ $labels.instance }} has {{ printf \"%.1f\" $value }}% of max connections used."

      # PostgreSQL Connection Critical
      - alert: PostgreSQLConnectionsCritical
        expr: (pg_stat_activity_count / pg_settings_max_connections) * 100 > 95
        for: 2m
        labels:
          severity: critical
          service: postgresql
        annotations:
          summary: "PostgreSQL connections critical"
          description: "PostgreSQL {{ $labels.instance }} has {{ printf \"%.1f\" $value }}% of max connections used. Connection exhaustion imminent."

      # PostgreSQL Deadlock
      - alert: PostgreSQLDeadlock
        expr: rate(pg_stat_database_deadlocks[5m]) > 0
        for: 5m
        labels:
          severity: warning
          service: postgresql
        annotations:
          summary: "PostgreSQL deadlocks detected"
          description: "PostgreSQL {{ $labels.datname }} is experiencing {{ printf \"%.2f\" $value }} deadlocks per second."

      # PostgreSQL Slow Queries
      - alert: PostgreSQLSlowQueries
        expr: avg(pg_stat_activity_max_tx_duration{state="active"}) > 300
        for: 5m
        labels:
          severity: warning
          service: postgresql
        annotations:
          summary: "PostgreSQL slow queries detected"
          description: "PostgreSQL has queries running for more than 5 minutes."

      # PostgreSQL High Rollback Rate
      - alert: PostgreSQLHighRollbackRate
        expr: rate(pg_stat_database_xact_rollback[5m]) / (rate(pg_stat_database_xact_commit[5m]) + rate(pg_stat_database_xact_rollback[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
          service: postgresql
        annotations:
          summary: "PostgreSQL high rollback rate"
          description: "PostgreSQL {{ $labels.datname }} has {{ printf \"%.1f\" (mul $value 100) }}% transaction rollback rate."

      # PostgreSQL Replication Lag (for replicas)
      - alert: PostgreSQLReplicationLag
        expr: pg_replication_lag > 30
        for: 2m
        labels:
          severity: warning
          service: postgresql
        annotations:
          summary: "PostgreSQL replication lag"
          description: "PostgreSQL replica {{ $labels.instance }} is {{ printf \"%.1f\" $value }} seconds behind master."

      # PostgreSQL Replication Lag Critical
      - alert: PostgreSQLReplicationLagCritical
        expr: pg_replication_lag > 120
        for: 2m
        labels:
          severity: critical
          service: postgresql
        annotations:
          summary: "PostgreSQL replication lag critical"
          description: "PostgreSQL replica {{ $labels.instance }} is {{ printf \"%.1f\" $value }} seconds behind master. Immediate attention required."

      # PostgreSQL Cache Hit Rate Low
      - alert: PostgreSQLLowCacheHitRate
        expr: pg_stat_database_blks_hit / (pg_stat_database_blks_hit + pg_stat_database_blks_read) < 0.9
        for: 10m
        labels:
          severity: warning
          service: postgresql
        annotations:
          summary: "PostgreSQL cache hit rate low"
          description: "PostgreSQL {{ $labels.datname }} cache hit rate is {{ printf \"%.1f\" (mul $value 100) }}%."

      # PostgreSQL Table Bloat
      - alert: PostgreSQLTableBloat
        expr: pg_stat_user_tables_n_dead_tup > 1000000
        for: 30m
        labels:
          severity: warning
          service: postgresql
        annotations:
          summary: "PostgreSQL table bloat detected"
          description: "Table {{ $labels.relname }} has {{ $value }} dead tuples. Consider running VACUUM."
