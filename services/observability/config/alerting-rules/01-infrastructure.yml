# =============================================================================
# Infrastructure Alerts (Node Exporter)
# =============================================================================
# Toggle: ALERTS_INFRASTRUCTURE=true in .env
# Disable: Rename to 01-infrastructure.yml.disabled

groups:
  - name: infrastructure
    interval: 30s
    rules:
      # High CPU Usage - Warning
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is {{ printf \"%.1f\" $value }}% (above 80%) for more than 5 minutes."

      # Critical CPU Usage
      - alert: CriticalCPUUsage
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 95
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Critical CPU usage on {{ $labels.instance }}"
          description: "CPU usage is {{ printf \"%.1f\" $value }}% (above 95%) for more than 2 minutes."

      # High Memory Usage - Warning
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage is {{ printf \"%.1f\" $value }}% (above 85%) for more than 5 minutes."

      # Critical Memory Usage
      - alert: CriticalMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 95
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Critical memory usage on {{ $labels.instance }}"
          description: "Memory usage is {{ printf \"%.1f\" $value }}% (above 95%) for more than 2 minutes."

      # Disk Space Low - Warning
      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}) * 100 < 15
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Low disk space on {{ $labels.instance }}"
          description: "Disk space is {{ printf \"%.1f\" $value }}% available on {{ $labels.mountpoint }}."

      # Critical Disk Space
      - alert: CriticalDiskSpace
        expr: (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}) * 100 < 5
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Critical disk space on {{ $labels.instance }}"
          description: "Disk space is {{ printf \"%.1f\" $value }}% available on {{ $labels.mountpoint }}. Immediate action required."

      # High Disk I/O
      - alert: HighDiskIOUtilization
        expr: rate(node_disk_io_time_seconds_total[5m]) * 100 > 90
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High disk I/O on {{ $labels.instance }}"
          description: "Disk {{ $labels.device }} has {{ printf \"%.1f\" $value }}% I/O utilization."

      # Network Interface Down
      - alert: NetworkInterfaceDown
        expr: node_network_up{device!~"lo|veth.*|docker.*|br-.*"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Network interface {{ $labels.device }} is down"
          description: "Network interface {{ $labels.device }} on {{ $labels.instance }} is down."

      # High Network Traffic
      - alert: HighNetworkBandwidth
        expr: rate(node_network_receive_bytes_total{device!~"lo|veth.*|docker.*|br-.*"}[5m]) > 100000000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High network receive traffic on {{ $labels.instance }}"
          description: "Network interface {{ $labels.device }} receiving {{ humanize $value }}B/s."

      # Host Out of Inodes
      - alert: HostOutOfInodes
        expr: node_filesystem_files_free{fstype!~"tmpfs|overlay"} / node_filesystem_files{fstype!~"tmpfs|overlay"} * 100 < 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Host out of inodes on {{ $labels.instance }}"
          description: "{{ $labels.mountpoint }} has only {{ printf \"%.1f\" $value }}% inodes available."

      # System Clock Skew
      - alert: ClockSkewDetected
        expr: abs(node_timex_offset_seconds) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Clock skew detected on {{ $labels.instance }}"
          description: "Clock is {{ printf \"%.3f\" $value }} seconds off."
