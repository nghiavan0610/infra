# =============================================================================
# Prometheus Configuration - Production
# =============================================================================

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'production'
    environment: 'production'

# -----------------------------------------------------------------------------
# Alerting Configuration
# -----------------------------------------------------------------------------
alerting:
  alertmanagers:
    - static_configs:
        - targets: ['alertmanager:9093']

# -----------------------------------------------------------------------------
# Rule Files
# -----------------------------------------------------------------------------
# Modular alert rules - each category in separate file
# Disable alerts by renaming file to .disabled or using toggle-alerts.sh
rule_files:
  - /etc/prometheus/alerting-rules/*.yml

# -----------------------------------------------------------------------------
# Scrape Configurations
# -----------------------------------------------------------------------------
scrape_configs:
  # -----------------------------------------
  # Prometheus self-monitoring
  # -----------------------------------------
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: 'prometheus'

  # -----------------------------------------
  # Node Exporter - Host metrics
  # -----------------------------------------
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
        labels:
          service: 'node-exporter'

  # -----------------------------------------
  # cAdvisor - Container metrics
  # -----------------------------------------
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']
        labels:
          service: 'cadvisor'

  # -----------------------------------------
  # OpenTelemetry Collector metrics
  # -----------------------------------------
  - job_name: 'otel-collector'
    static_configs:
      - targets: ['otel-collector:8888', 'otel-collector:8889']
        labels:
          service: 'otel-collector'

  # -----------------------------------------
  # Loki metrics
  # -----------------------------------------
  - job_name: 'loki'
    static_configs:
      - targets: ['loki:3100']
        labels:
          service: 'loki'

  # -----------------------------------------
  # Tempo metrics
  # -----------------------------------------
  - job_name: 'tempo'
    static_configs:
      - targets: ['tempo:3200']
        labels:
          service: 'tempo'

  # -----------------------------------------
  # Grafana metrics
  # -----------------------------------------
  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana:3000']
        labels:
          service: 'grafana'

  # -----------------------------------------
  # Alertmanager metrics
  # -----------------------------------------
  - job_name: 'alertmanager'
    static_configs:
      - targets: ['alertmanager:9093']
        labels:
          service: 'alertmanager'

  # -----------------------------------------
  # PostgreSQL - Dynamic file-based discovery
  # -----------------------------------------
  # Add/remove targets by editing /targets/postgres.json
  # Prometheus reloads automatically (no restart needed)
  - job_name: 'postgresql'
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/postgres.json
        refresh_interval: 30s

  # -----------------------------------------
  # Redis - Dynamic file-based discovery (multi-target mode)
  # -----------------------------------------
  # Add/remove targets by editing /targets/redis.json
  - job_name: 'redis'
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/redis.json
        refresh_interval: 30s
    metrics_path: /scrape
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: redis-exporter:9121

  # -----------------------------------------
  # NATS - Dynamic file-based discovery
  # -----------------------------------------
  - job_name: 'nats'
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/nats.json
        refresh_interval: 30s

  # -----------------------------------------
  # RabbitMQ - Dynamic file-based discovery
  # -----------------------------------------
  - job_name: 'rabbitmq'
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/rabbitmq.json
        refresh_interval: 30s
    metrics_path: '/metrics'

  # -----------------------------------------
  # MongoDB - Dynamic file-based discovery
  # -----------------------------------------
  - job_name: 'mongodb'
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/mongodb.json
        refresh_interval: 30s
    metrics_path: '/metrics'

  # -----------------------------------------
  # Traefik - Dynamic file-based discovery
  # -----------------------------------------
  - job_name: 'traefik'
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/traefik.json
        refresh_interval: 30s
    metrics_path: '/metrics'

  # -----------------------------------------
  # Garage (S3 storage) - Dynamic file-based discovery
  # -----------------------------------------
  # Requires GARAGE_METRICS_TOKEN from garage/.env
  - job_name: 'garage'
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/garage.json
        refresh_interval: 30s
    metrics_path: '/metrics'
    authorization:
      type: Bearer
      credentials_file: /etc/prometheus/secrets/garage-metrics-token

  # -----------------------------------------
  # MySQL - Dynamic file-based discovery
  # -----------------------------------------
  - job_name: 'mysql'
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/mysql.json
        refresh_interval: 30s
    metrics_path: '/metrics'

  # -----------------------------------------
  # Memcached - Dynamic file-based discovery
  # -----------------------------------------
  - job_name: 'memcached'
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/memcached.json
        refresh_interval: 30s
    metrics_path: '/metrics'

  # -----------------------------------------
  # Kafka - Dynamic file-based discovery
  # -----------------------------------------
  - job_name: 'kafka'
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/kafka.json
        refresh_interval: 30s
    metrics_path: '/metrics'

  # -----------------------------------------
  # ClickHouse - Dynamic file-based discovery
  # -----------------------------------------
  - job_name: 'clickhouse'
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/clickhouse.json
        refresh_interval: 30s
    metrics_path: '/metrics'

  # -----------------------------------------
  # MinIO - Dynamic file-based discovery
  # -----------------------------------------
  - job_name: 'minio'
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/minio.json
        refresh_interval: 30s
    metrics_path: '/minio/v2/metrics/cluster'

  # -----------------------------------------
  # Qdrant - Dynamic file-based discovery
  # -----------------------------------------
  - job_name: 'qdrant'
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/qdrant.json
        refresh_interval: 30s
    metrics_path: '/metrics'

  # -----------------------------------------
  # LangFuse - LLM Observability
  # -----------------------------------------
  - job_name: 'langfuse'
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/langfuse.json
        refresh_interval: 30s
    metrics_path: '/api/public/metrics'

  # -----------------------------------------
  # Application metrics - Dynamic file-based discovery
  # -----------------------------------------
  # Add your applications to /targets/applications.json
  - job_name: 'applications'
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/applications.json
        refresh_interval: 30s
    metrics_path: '/metrics'
    scrape_interval: 15s

  # -----------------------------------------
  # Docker label-based auto-discovery
  # -----------------------------------------
  # Docker Auto-Discovery (disabled by default - requires Docker socket permission)
  # To enable:
  #   1. Get Docker group GID: stat -c '%g' /var/run/docker.sock
  #   2. Add to prometheus service in docker-compose.yml:
  #      group_add:
  #        - "999"  # Replace with actual GID
  #   3. Uncomment the job below
  #
  # Any container with these labels will be auto-scraped:
  #   labels:
  #     - "prometheus.scrape=true"
  #     - "prometheus.port=8080"
  #     - "prometheus.path=/metrics"  (optional, defaults to /metrics)
  #
  # - job_name: 'docker-containers'
  #   docker_sd_configs:
  #     - host: unix:///var/run/docker.sock
  #       refresh_interval: 30s
  #   relabel_configs:
  #     - source_labels: [__meta_docker_container_label_prometheus_scrape]
  #       regex: 'true'
  #       action: keep
  #     - source_labels: [__meta_docker_container_label_prometheus_port]
  #       regex: '(\d+)'
  #       target_label: __address__
  #       replacement: '${1}'
  #     - source_labels: [__meta_docker_container_name, __meta_docker_container_label_prometheus_port]
  #       regex: '/?(.+);(\d+)'
  #       target_label: __address__
  #       replacement: '${1}:${2}'
  #     - source_labels: [__meta_docker_container_label_prometheus_path]
  #       regex: '(.+)'
  #       target_label: __metrics_path__
  #       replacement: '${1}'
  #     - source_labels: [__meta_docker_container_name]
  #       regex: '/?(.+)'
  #       target_label: instance
  #       replacement: '${1}'
  #     - source_labels: [__meta_docker_container_name]
  #       regex: '/?(.+)'
  #       target_label: service
  #       replacement: '${1}'
  #     - source_labels: [__meta_docker_container_label_app]
  #       regex: '(.+)'
  #       target_label: app
  #       replacement: '${1}'
