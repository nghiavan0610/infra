# =============================================================================
# Prometheus Configuration - Production (Alloy-based)
# =============================================================================
# Most metrics are collected by Grafana Alloy and sent via remote_write.
# Prometheus only scrapes the observability stack itself and special cases.
# =============================================================================

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'production'
    environment: 'production'

# -----------------------------------------------------------------------------
# Alerting Configuration
# -----------------------------------------------------------------------------
alerting:
  alertmanagers:
    - static_configs:
        - targets: ['alertmanager:9093']

# -----------------------------------------------------------------------------
# Rule Files
# -----------------------------------------------------------------------------
rule_files:
  - /etc/prometheus/alerting-rules/*.yml

# -----------------------------------------------------------------------------
# Scrape Configurations
# -----------------------------------------------------------------------------
# Alloy handles via remote_write:
#   - Host metrics (CPU, RAM, disk)
#   - Container metrics
#   - Redis, PostgreSQL, MongoDB, MySQL, Memcached, Kafka, Elasticsearch
#   - NATS, RabbitMQ, Traefik, ClickHouse, Meilisearch, Qdrant, MinIO
#
# Prometheus directly scrapes:
#   - Observability stack (prometheus, alloy, loki, tempo, grafana, alertmanager)
#   - Garage (requires bearer token)
#   - LangFuse (custom endpoint)
#   - Custom applications
# -----------------------------------------------------------------------------
scrape_configs:
  # ===========================================================================
  # Observability Stack (scraped directly)
  # ===========================================================================

  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  - job_name: 'alloy'
    static_configs:
      - targets: ['alloy:12345']

  - job_name: 'loki'
    static_configs:
      - targets: ['loki:3100']

  - job_name: 'tempo'
    static_configs:
      - targets: ['tempo:3200']

  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana:3000']

  - job_name: 'alertmanager'
    static_configs:
      - targets: ['alertmanager:9093']

  # ===========================================================================
  # Special Cases (require auth or custom paths)
  # ===========================================================================

  # Garage S3 Storage - requires bearer token
  - job_name: 'garage'
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/garage.json
        refresh_interval: 30s
    metrics_path: '/metrics'
    authorization:
      type: Bearer
      credentials_file: /etc/prometheus/secrets/garage-metrics-token

  # LangFuse - custom metrics endpoint
  - job_name: 'langfuse'
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/langfuse.json
        refresh_interval: 30s
    metrics_path: '/api/public/metrics'

  # ===========================================================================
  # Custom Applications
  # ===========================================================================
  # Add your applications to /targets/applications.json

  - job_name: 'applications'
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/applications.json
        refresh_interval: 30s
    metrics_path: '/metrics'
