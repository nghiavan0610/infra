# =============================================================================
# PostgreSQL Production Configuration
# Single Node Setup - Optimized for reliability and performance
# =============================================================================

# -----------------------------------------------------------------------------
# Connection Settings
# -----------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
max_connections = 200

# -----------------------------------------------------------------------------
# Authentication
# -----------------------------------------------------------------------------
password_encryption = scram-sha-256

# -----------------------------------------------------------------------------
# Memory Settings (Adjust based on your VPS RAM)
# -----------------------------------------------------------------------------
# Formula:
#   shared_buffers = 25% of RAM
#   effective_cache_size = 75% of RAM
#   work_mem = (RAM - shared_buffers) / (max_connections * 3)
#   maintenance_work_mem = RAM / 16

# Small VPS (2 GB RAM)
# shared_buffers = 512MB
# effective_cache_size = 1536MB
# work_mem = 4MB
# maintenance_work_mem = 128MB

# Medium VPS (4-8 GB RAM)
# shared_buffers = 1GB
# effective_cache_size = 3GB
# work_mem = 8MB
# maintenance_work_mem = 256MB

# 10 GB RAM (Oracle Cloud 2 OCPU) - Conservative for multi-app server
# Leave room for HireStack workers + other apps
shared_buffers = 1536MB          # ~1.5GB
effective_cache_size = 4096MB    # ~4GB (OS cache helps too)
work_mem = 8MB
maintenance_work_mem = 256MB

# Large VPS (16 GB RAM)
# shared_buffers = 4GB
# effective_cache_size = 12GB
# work_mem = 16MB
# maintenance_work_mem = 512MB

# Extra Large VPS (32+ GB RAM)
# shared_buffers = 8GB
# effective_cache_size = 24GB
# work_mem = 32MB
# maintenance_work_mem = 1GB

# -----------------------------------------------------------------------------
# Write-Ahead Log (WAL) - CRITICAL FOR DATA SAFETY
# -----------------------------------------------------------------------------
# NEVER disable these in production!
wal_level = replica                    # Enables streaming replication & PITR
synchronous_commit = on                # CRITICAL: Ensures durability
full_page_writes = on                  # CRITICAL: Prevents corruption after crash
wal_compression = on                   # Reduces WAL size
wal_buffers = 64MB                     # WAL buffer size

# Checkpoints
checkpoint_timeout = 10min             # Time between checkpoints
checkpoint_completion_target = 0.9     # Spread checkpoint writes
max_wal_size = 1GB                     # Max WAL before checkpoint
min_wal_size = 256MB                   # Min WAL to retain

# -----------------------------------------------------------------------------
# Query Tuning
# -----------------------------------------------------------------------------
random_page_cost = 1.1                 # SSD optimization (use 4.0 for HDD)
effective_io_concurrency = 200         # SSD optimization (use 2 for HDD)
default_statistics_target = 100        # Statistics accuracy

# Parallelism (adjust based on CPU cores)
max_worker_processes = 4
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2

# -----------------------------------------------------------------------------
# Logging (Docker captures stderr - use 'docker compose logs')
# -----------------------------------------------------------------------------
logging_collector = off
log_destination = 'stderr'

# What to log
log_min_duration_statement = 1000      # Log queries > 1 second
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0                     # Log all temp files
log_autovacuum_min_duration = 0        # Log all autovacuum

# Log format
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_statement = 'ddl'                  # Log DDL statements

# -----------------------------------------------------------------------------
# Autovacuum
# -----------------------------------------------------------------------------
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_cost_delay = 2ms
autovacuum_vacuum_cost_limit = 1000

# -----------------------------------------------------------------------------
# Client Connection Defaults
# -----------------------------------------------------------------------------
timezone = 'UTC'
lc_messages = 'C'
lc_monetary = 'C'
lc_numeric = 'C'
lc_time = 'C'
default_text_search_config = 'pg_catalog.english'

# -----------------------------------------------------------------------------
# Lock Management
# -----------------------------------------------------------------------------
deadlock_timeout = 1s
max_locks_per_transaction = 128

# -----------------------------------------------------------------------------
# Error Handling
# -----------------------------------------------------------------------------
exit_on_error = off
restart_after_crash = on

# -----------------------------------------------------------------------------
# Statistics
# -----------------------------------------------------------------------------
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
