# =============================================================================
# PostgreSQL Master Configuration - Production Replica Setup
# =============================================================================

# -----------------------------------------------------------------------------
# Connection Settings
# -----------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
max_connections = 200

# -----------------------------------------------------------------------------
# Authentication
# -----------------------------------------------------------------------------
password_encryption = scram-sha-256

# -----------------------------------------------------------------------------
# Memory Settings (Adjust based on VPS RAM)
# -----------------------------------------------------------------------------
# Medium VPS (4-8 GB RAM) - DEFAULT
shared_buffers = 1GB
effective_cache_size = 3GB
work_mem = 8MB
maintenance_work_mem = 256MB

# Large VPS (16 GB RAM)
# shared_buffers = 4GB
# effective_cache_size = 12GB
# work_mem = 16MB
# maintenance_work_mem = 512MB

# -----------------------------------------------------------------------------
# Write-Ahead Log (WAL) - CRITICAL FOR REPLICATION
# -----------------------------------------------------------------------------
wal_level = replica                    # Required for streaming replication
synchronous_commit = on                # CRITICAL: Data durability
full_page_writes = on                  # CRITICAL: Crash recovery safety
wal_compression = on                   # Reduce WAL size
wal_buffers = 64MB

# Replication slots (prevents WAL removal before replica catches up)
max_replication_slots = 4

# WAL senders (one per replica + buffer)
max_wal_senders = 5

# WAL retention for replicas
wal_keep_size = 1GB                    # Keep 1GB of WAL for replicas

# Synchronous replication (optional - enable for zero data loss)
# synchronous_standby_names = 'postgres-slave'

# -----------------------------------------------------------------------------
# Checkpoints
# -----------------------------------------------------------------------------
checkpoint_timeout = 10min
checkpoint_completion_target = 0.9
max_wal_size = 2GB
min_wal_size = 512MB

# -----------------------------------------------------------------------------
# Query Tuning (SSD optimized)
# -----------------------------------------------------------------------------
random_page_cost = 1.1
effective_io_concurrency = 200
default_statistics_target = 100

# Parallelism
max_worker_processes = 4
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2

# -----------------------------------------------------------------------------
# Replication & Standby
# -----------------------------------------------------------------------------
hot_standby = on                       # Allow queries on standby
hot_standby_feedback = on              # Replica sends feedback to master

# -----------------------------------------------------------------------------
# Logging (Docker captures stderr - use 'docker compose logs')
# -----------------------------------------------------------------------------
logging_collector = off
log_destination = 'stderr'

# What to log
log_min_duration_statement = 1000      # Log queries > 1 second
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_replication_commands = on          # Log replication activity
log_temp_files = 0

# Log format
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_statement = 'ddl'

# -----------------------------------------------------------------------------
# Autovacuum
# -----------------------------------------------------------------------------
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.05

# -----------------------------------------------------------------------------
# Client Connection Defaults
# -----------------------------------------------------------------------------
timezone = 'UTC'
lc_messages = 'en_US.UTF-8'

# -----------------------------------------------------------------------------
# Lock Management
# -----------------------------------------------------------------------------
deadlock_timeout = 1s
max_locks_per_transaction = 128

# -----------------------------------------------------------------------------
# Error Handling
# -----------------------------------------------------------------------------
restart_after_crash = on

# -----------------------------------------------------------------------------
# Statistics
# -----------------------------------------------------------------------------
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
