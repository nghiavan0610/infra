# =============================================================================
# Redis Production Configuration - Cache & Queue
# =============================================================================
# Two isolated Redis instances:
#   - redis-cache (6379): Volatile cache with LRU eviction
#   - redis-queue (6380): Persistent queue with no eviction
#
# Usage:
#   docker compose up -d              # Start both instances
#   docker compose up -d redis-cache  # Start cache only
#   docker compose up -d redis-queue  # Start queue only
#   docker compose logs -f            # View logs
# =============================================================================

services:
  # ===========================================================================
  # Redis Cache - Volatile data, LRU eviction, no persistence
  # ===========================================================================
  # Use for: API responses, session data, temporary data
  # ===========================================================================
  redis-cache:
    image: redis:7-alpine
    container_name: redis-cache
    restart: unless-stopped

    environment:
      - TZ=UTC

    command:
      - redis-server
      - /usr/local/etc/redis/redis.conf
      - --requirepass
      - ${REDIS_CACHE_PASSWORD}

    ports:
      - "${REDIS_CACHE_PORT:-6379}:6379"

    volumes:
      # Minimal data dir (for temp files only, no persistence)
      - redis_cache_data:/data
      # Cache-optimized configuration
      - ./config/redis-cache.conf:/usr/local/etc/redis/redis.conf:ro

    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 768M    # maxmemory (512mb) + overhead
        reservations:
          cpus: '0.25'
          memory: 128M

    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_CACHE_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    security_opt:
      - no-new-privileges:true

    sysctls:
      - net.core.somaxconn=511

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    networks:
      - redis-network
      - infra           # For access from other infra services

  # ===========================================================================
  # Redis Queue - Persistent data, no eviction, full durability
  # ===========================================================================
  # Use for: BullMQ, Bee-Queue, Agenda, any job queue
  # ===========================================================================
  redis-queue:
    image: redis:7-alpine
    container_name: redis-queue
    restart: unless-stopped

    environment:
      - TZ=UTC

    command:
      - redis-server
      - /usr/local/etc/redis/redis.conf
      - --requirepass
      - ${REDIS_QUEUE_PASSWORD}

    ports:
      - "${REDIS_QUEUE_PORT:-6380}:6379"

    volumes:
      # Persistent data (RDB + AOF)
      - redis_queue_data:/data
      # Queue-optimized configuration
      - ./config/redis-queue.conf:/usr/local/etc/redis/redis.conf:ro

    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 768M    # maxmemory (512mb) + overhead
        reservations:
          cpus: '0.25'
          memory: 128M

    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_QUEUE_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    security_opt:
      - no-new-privileges:true

    sysctls:
      - net.core.somaxconn=511

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    networks:
      - redis-network
      - infra           # For access from other infra services

# =============================================================================
# Volumes
# =============================================================================
volumes:
  # Cache volume (can be deleted without data loss)
  redis_cache_data:
    driver: local
    name: redis_cache_data

  # Queue volume (CRITICAL - contains job data, include in backups)
  redis_queue_data:
    driver: local
    name: redis_queue_data

# =============================================================================
# Networks
# =============================================================================
networks:
  redis-network:
    driver: bridge
    name: redis-network
  infra:
    external: true
