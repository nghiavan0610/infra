# =============================================================================
# Redis Queue Configuration
# =============================================================================
# Optimized for queues: persistent data, no eviction, full durability
# Use with: BullMQ, Bee-Queue, Agenda, or any job queue system
# =============================================================================

# -----------------------------------------------------------------------------
# Network
# -----------------------------------------------------------------------------
bind 0.0.0.0
port 6379
protected-mode yes
tcp-backlog 511
tcp-keepalive 300
timeout 0

# -----------------------------------------------------------------------------
# General
# -----------------------------------------------------------------------------
daemonize no
pidfile /var/run/redis/redis-server.pid
loglevel notice
logfile ""
databases 16

# -----------------------------------------------------------------------------
# Security
# -----------------------------------------------------------------------------
# Password is set via command line (--requirepass)
# Disable dangerous commands in production
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command DEBUG ""
rename-command CONFIG "CONFIG_qu3u3_s3cr3t"
rename-command SHUTDOWN "SHUTDOWN_qu3u3_s3cr3t"

# -----------------------------------------------------------------------------
# Memory Management
# -----------------------------------------------------------------------------
# Max memory for queue (adjust based on VPS RAM and expected queue size)
# Queue memory usage depends on job payload sizes
# Small VPS (1-2GB RAM): 256mb
# Medium VPS (4-8GB RAM): 512mb-1gb
# Large VPS (16GB+ RAM): 2-4gb
maxmemory 512mb

# CRITICAL: noeviction - return error instead of evicting data
# Queue jobs must NEVER be evicted - they would be lost forever
maxmemory-policy noeviction

# -----------------------------------------------------------------------------
# Persistence - RDB (Snapshotting)
# -----------------------------------------------------------------------------
# Save to disk frequently for queue data
# After 900 sec (15 min) if at least 1 key changed
# After 300 sec (5 min) if at least 10 keys changed
# After 60 sec if at least 1000 keys changed
save 900 1
save 300 10
save 60 1000

# Stop accepting writes on RDB save error (data integrity)
stop-writes-on-bgsave-error yes

# Compress RDB files
rdbcompression yes

# RDB checksum
rdbchecksum yes

# Sanitize dump payloads
sanitize-dump-payload clients

# RDB filename
dbfilename dump.rdb

# Working directory
dir /data

# -----------------------------------------------------------------------------
# Persistence - AOF (Append Only File)
# -----------------------------------------------------------------------------
# CRITICAL: Enable AOF for queue durability
appendonly yes

# AOF filename
appendfilename "appendonly.aof"

# AOF directory (Redis 7+)
appenddirname "appendonlydir"

# fsync policy: everysec is good balance of performance and durability
# Use "always" for critical queues (slower but safest)
appendfsync everysec

# Don't fsync during rewrite
no-appendfsync-on-rewrite no

# Auto-rewrite AOF when it grows
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Load truncated AOF on startup
aof-load-truncated yes

# Enable RDB-AOF hybrid persistence (Redis 7+)
aof-use-rdb-preamble yes

# -----------------------------------------------------------------------------
# Slow Log
# -----------------------------------------------------------------------------
slowlog-log-slower-than 10000
slowlog-max-len 128

# -----------------------------------------------------------------------------
# Latency Monitor
# -----------------------------------------------------------------------------
latency-monitor-threshold 100

# -----------------------------------------------------------------------------
# Client Output Buffer Limits
# -----------------------------------------------------------------------------
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# -----------------------------------------------------------------------------
# Clients
# -----------------------------------------------------------------------------
maxclients 10000

# -----------------------------------------------------------------------------
# Lazy Freeing (Background deletion)
# -----------------------------------------------------------------------------
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
lazyfree-lazy-user-del yes
lazyfree-lazy-user-flush yes

# -----------------------------------------------------------------------------
# Active Defragmentation
# -----------------------------------------------------------------------------
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 1
active-defrag-cycle-max 25
