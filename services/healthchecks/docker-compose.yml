# =============================================================================
# Healthchecks - Cron Job Monitoring
# =============================================================================
# Uses shared PostgreSQL service
#
# Prerequisites:
#   - PostgreSQL running (shared postgres)
#
# Usage:
#   docker compose up -d
#
# Access: http://localhost:8002
# =============================================================================

services:
  healthchecks:
    image: healthchecks/healthchecks:latest
    container_name: healthchecks
    restart: unless-stopped
    environment:
      # Site settings
      - SITE_ROOT=${HEALTHCHECKS_SITE_ROOT:-http://localhost:8002}
      - SITE_NAME=${HEALTHCHECKS_SITE_NAME:-Healthchecks}
      - DEFAULT_FROM_EMAIL=${HEALTHCHECKS_FROM_EMAIL:-healthchecks@localhost}
      - SECRET_KEY=${HEALTHCHECKS_SECRET_KEY}
      # Shared PostgreSQL
      - DB=postgres
      - DB_HOST=${POSTGRES_HOST:-postgres}
      - DB_PORT=${POSTGRES_PORT:-5432}
      - DB_NAME=${HEALTHCHECKS_DB_NAME:-healthchecks}
      - DB_USER=${POSTGRES_USER:-postgres}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      # Features
      - REGISTRATION_OPEN=${HEALTHCHECKS_REGISTRATION_OPEN:-false}
      - PING_ENDPOINT=${HEALTHCHECKS_PING_ENDPOINT:-http://localhost:8002/ping/}
      # Email (optional)
      - EMAIL_HOST=${HEALTHCHECKS_EMAIL_HOST:-}
      - EMAIL_PORT=${HEALTHCHECKS_EMAIL_PORT:-587}
      - EMAIL_HOST_USER=${HEALTHCHECKS_EMAIL_USER:-}
      - EMAIL_HOST_PASSWORD=${HEALTHCHECKS_EMAIL_PASSWORD:-}
      - EMAIL_USE_TLS=${HEALTHCHECKS_EMAIL_USE_TLS:-True}
      # Integrations
      - SLACK_CLIENT_ID=${HEALTHCHECKS_SLACK_CLIENT_ID:-}
      - SLACK_CLIENT_SECRET=${HEALTHCHECKS_SLACK_CLIENT_SECRET:-}
      - DISCORD_CLIENT_ID=${HEALTHCHECKS_DISCORD_CLIENT_ID:-}
      - DISCORD_CLIENT_SECRET=${HEALTHCHECKS_DISCORD_CLIENT_SECRET:-}
    ports:
      - "${HEALTHCHECKS_PORT:-8002}:8000"
    volumes:
      - healthchecks_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/status/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - infra
    labels:
      - "traefik.enable=false"

volumes:
  healthchecks_data:

networks:
  infra:
    external: true
