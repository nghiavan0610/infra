# =============================================================================
# TimescaleDB PostgreSQL Configuration
# =============================================================================
# Optimized for time-series workloads: IoT, metrics, logs, analytics
# Tuned for: Write-heavy, bulk inserts, compression, continuous aggregates
# =============================================================================

# -----------------------------------------------------------------------------
# Connection Settings
# -----------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
max_connections = 100

# -----------------------------------------------------------------------------
# Memory Settings (Adjust based on available RAM)
# -----------------------------------------------------------------------------
# For 4GB RAM VPS (adjust proportionally for your setup)
# Rule: shared_buffers = 25% of RAM, effective_cache_size = 75% of RAM

shared_buffers = 1GB                    # 25% of 4GB
effective_cache_size = 3GB              # 75% of 4GB
maintenance_work_mem = 512MB            # For VACUUM, CREATE INDEX
work_mem = 64MB                         # Per-operation memory (higher for analytics)

# Huge pages (enable if OS supports it)
huge_pages = try

# -----------------------------------------------------------------------------
# TimescaleDB Specific Settings
# -----------------------------------------------------------------------------
# Preload TimescaleDB library
shared_preload_libraries = 'timescaledb'

# TimescaleDB tuning
timescaledb.max_background_workers = 8
timescaledb.last_tuned = '2024-01-01T00:00:00Z'
timescaledb.last_tuned_version = '2.13.0'

# -----------------------------------------------------------------------------
# Write-Ahead Log (WAL) - Optimized for time-series writes
# -----------------------------------------------------------------------------
wal_level = replica
max_wal_size = 4GB                      # Allow larger WAL for bulk writes
min_wal_size = 1GB
wal_compression = on                    # Compress WAL (saves disk I/O)
wal_buffers = 64MB                      # Larger buffer for write-heavy workloads

# Checkpoints (less frequent = better write performance)
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9

# -----------------------------------------------------------------------------
# Background Workers (for compression, continuous aggregates)
# -----------------------------------------------------------------------------
max_worker_processes = 16               # Enough for TimescaleDB background jobs
max_parallel_workers_per_gather = 4
max_parallel_workers = 8
max_parallel_maintenance_workers = 4

# -----------------------------------------------------------------------------
# Query Planner - Optimized for time-series queries
# -----------------------------------------------------------------------------
# SSD settings (set to 1.1 for SSD, 4.0 for HDD)
random_page_cost = 1.1
effective_io_concurrency = 200          # Higher for SSD

# Parallel query settings
parallel_tuple_cost = 0.01
parallel_setup_cost = 100

# Enable JIT compilation for complex queries
jit = on

# Planner settings for time-series
default_statistics_target = 100
constraint_exclusion = partition        # Important for hypertable performance

# -----------------------------------------------------------------------------
# Autovacuum - Tuned for time-series tables
# -----------------------------------------------------------------------------
autovacuum = on
autovacuum_max_workers = 4
autovacuum_naptime = 30s                # Check more frequently
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.05   # More aggressive for time-series
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_cost_delay = 2ms      # Faster vacuum
autovacuum_vacuum_cost_limit = 1000

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on

# What to log
log_min_duration_statement = 1000       # Log queries > 1 second
log_checkpoints = on
log_connections = off                   # Reduce log noise for high-connection workloads
log_disconnections = off
log_lock_waits = on
log_temp_files = 0
log_autovacuum_min_duration = 1000      # Log autovacuum > 1 second
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# -----------------------------------------------------------------------------
# Statistics
# -----------------------------------------------------------------------------
track_activities = on
track_counts = on
track_io_timing = on                    # Important for performance analysis
track_functions = all

# -----------------------------------------------------------------------------
# Lock Management
# -----------------------------------------------------------------------------
deadlock_timeout = 1s
max_locks_per_transaction = 256         # Higher for hypertables with many chunks

# -----------------------------------------------------------------------------
# Client Connection Defaults
# -----------------------------------------------------------------------------
timezone = 'UTC'
datestyle = 'iso, mdy'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# -----------------------------------------------------------------------------
# Statement Behavior
# -----------------------------------------------------------------------------
statement_timeout = 0                   # No timeout (set per-session for queries)
idle_in_transaction_session_timeout = 30min
