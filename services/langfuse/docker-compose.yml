# =============================================================================
# LangFuse - LLM Observability Platform
# =============================================================================
# Uses shared PostgreSQL, Redis, and optionally ClickHouse
#
# Prerequisites:
#   - PostgreSQL running (shared postgres)
#   - Redis running (shared redis-cache)
#   - ClickHouse running (optional, shared clickhouse)
#
# Usage:
#   docker compose up -d                    # Basic (no ClickHouse)
#   docker compose --profile worker up -d   # With background worker (v3)
#
# Access: http://localhost:3050
# =============================================================================

services:
  # ===========================================================================
  # LangFuse Server (Main Application)
  # ===========================================================================
  langfuse:
    image: langfuse/langfuse:${LANGFUSE_VERSION:-2}
    container_name: langfuse
    restart: unless-stopped
    environment:
      - TZ=UTC
      # Shared PostgreSQL
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@${POSTGRES_HOST:-postgres}:${POSTGRES_PORT:-5432}/${LANGFUSE_DB_NAME:-langfuse}
      # Shared Redis
      - REDIS_HOST=${REDIS_HOST:-redis-cache}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_AUTH=${REDIS_PASSWORD:-}
      # Shared ClickHouse (optional)
      - CLICKHOUSE_MIGRATION_URL=${LANGFUSE_CLICKHOUSE_URL:-}
      - CLICKHOUSE_URL=${LANGFUSE_CLICKHOUSE_URL:-}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-default}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:-}
      # Security
      - NEXTAUTH_SECRET=${LANGFUSE_NEXTAUTH_SECRET}
      - SALT=${LANGFUSE_SALT}
      - NEXTAUTH_URL=${LANGFUSE_URL:-http://localhost:3050}
      - TELEMETRY_ENABLED=${LANGFUSE_TELEMETRY:-false}
      # Authentication
      - AUTH_DISABLE_USERNAME_PASSWORD=${LANGFUSE_DISABLE_PASSWORD_AUTH:-false}
      - AUTH_DISABLE_SIGNUP=${LANGFUSE_DISABLE_SIGNUP:-false}
      # SSO (optional)
      - AUTH_GOOGLE_CLIENT_ID=${LANGFUSE_GOOGLE_CLIENT_ID:-}
      - AUTH_GOOGLE_CLIENT_SECRET=${LANGFUSE_GOOGLE_CLIENT_SECRET:-}
      - AUTH_GITHUB_CLIENT_ID=${LANGFUSE_GITHUB_CLIENT_ID:-}
      - AUTH_GITHUB_CLIENT_SECRET=${LANGFUSE_GITHUB_CLIENT_SECRET:-}
      # S3 Storage (optional)
      - LANGFUSE_S3_BUCKET_NAME=${LANGFUSE_S3_BUCKET:-}
      - LANGFUSE_S3_ENDPOINT=${LANGFUSE_S3_ENDPOINT:-}
      - LANGFUSE_S3_ACCESS_KEY_ID=${LANGFUSE_S3_ACCESS_KEY:-}
      - LANGFUSE_S3_SECRET_ACCESS_KEY=${LANGFUSE_S3_SECRET_KEY:-}
      - LANGFUSE_S3_REGION=${LANGFUSE_S3_REGION:-us-east-1}
      # Logging
      - LANGFUSE_LOG_LEVEL=${LANGFUSE_LOG_LEVEL:-info}
      - LANGFUSE_LOG_FORMAT=${LANGFUSE_LOG_FORMAT:-json}
    ports:
      - "${LANGFUSE_PORT:-3050}:3000"
    networks:
      - infra
    deploy:
      resources:
        limits:
          cpus: "${LANGFUSE_CPU_LIMIT:-2}"
          memory: ${LANGFUSE_MEMORY_LIMIT:-2G}
        reservations:
          cpus: "0.5"
          memory: 512M
    healthcheck:
      test: ["CMD", "sh", "-c", "wget -q --spider http://localhost:3000/api/public/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    security_opt:
      - no-new-privileges:true
    labels:
      - "prometheus.scrape=true"
      - "prometheus.port=3000"
      - "prometheus.path=/api/public/metrics"
      - "traefik.enable=${LANGFUSE_TRAEFIK_ENABLE:-false}"
      - "traefik.http.routers.langfuse.rule=Host(`${LANGFUSE_DOMAIN:-langfuse.localhost}`)"
      - "traefik.http.routers.langfuse.entrypoints=websecure"
      - "traefik.http.routers.langfuse.tls.certresolver=letsencrypt"
      - "traefik.http.services.langfuse.loadbalancer.server.port=3000"
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ===========================================================================
  # LangFuse Worker (optional - enable with --profile worker)
  # ===========================================================================
  langfuse-worker:
    image: langfuse/langfuse-worker:${LANGFUSE_VERSION:-2}
    container_name: langfuse-worker
    profiles:
      - worker
    restart: unless-stopped
    environment:
      - TZ=UTC
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@${POSTGRES_HOST:-postgres}:${POSTGRES_PORT:-5432}/${LANGFUSE_DB_NAME:-langfuse}
      - REDIS_HOST=${REDIS_HOST:-redis-cache}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_AUTH=${REDIS_PASSWORD:-}
      - CLICKHOUSE_MIGRATION_URL=${LANGFUSE_CLICKHOUSE_URL:-}
      - CLICKHOUSE_URL=${LANGFUSE_CLICKHOUSE_URL:-}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-default}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:-}
      - LANGFUSE_LOG_LEVEL=${LANGFUSE_LOG_LEVEL:-info}
    networks:
      - infra
    depends_on:
      langfuse:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "${LANGFUSE_WORKER_CPU_LIMIT:-1}"
          memory: ${LANGFUSE_WORKER_MEMORY_LIMIT:-1G}
        reservations:
          cpus: "0.25"
          memory: 256M
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

networks:
  infra:
    external: true
