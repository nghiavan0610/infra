# =============================================================================
# LangFuse - LLM Observability Platform
# =============================================================================
# Uses shared infrastructure: PostgreSQL, Redis, ClickHouse (optional)
#
# Modes:
#   v2 (simple):  PostgreSQL + Redis only
#   v2/v3 + CH:   PostgreSQL + Redis + shared ClickHouse
#
# Usage:
#   docker compose up -d                    # Basic (no ClickHouse)
#   docker compose --profile worker up -d   # With background worker (v3)
#
# Endpoints:
#   - UI:  http://localhost:3050
#   - API: http://localhost:3050/api
# =============================================================================

services:
  # ===========================================================================
  # LangFuse Server (Main Application)
  # ===========================================================================
  langfuse:
    image: langfuse/langfuse:${LANGFUSE_VERSION:-2}
    container_name: langfuse
    restart: unless-stopped
    environment:
      - TZ=UTC
      # --- Database (shared PostgreSQL) ---
      - DATABASE_URL=postgresql://${LANGFUSE_DB_USER:-langfuse}:${LANGFUSE_DB_PASS}@postgres:5432/${LANGFUSE_DB_NAME:-langfuse}

      # --- Redis (shared redis-cache) ---
      - REDIS_HOST=${LANGFUSE_REDIS_HOST:-redis-cache}
      - REDIS_PORT=${LANGFUSE_REDIS_PORT:-6379}
      - REDIS_AUTH=${LANGFUSE_REDIS_AUTH:-}

      # --- ClickHouse (shared, optional) ---
      # Leave empty to disable, or set to use shared clickhouse service
      - CLICKHOUSE_MIGRATION_URL=${LANGFUSE_CLICKHOUSE_URL:-}
      - CLICKHOUSE_URL=${LANGFUSE_CLICKHOUSE_URL:-}
      - CLICKHOUSE_USER=${LANGFUSE_CLICKHOUSE_USER:-default}
      - CLICKHOUSE_PASSWORD=${LANGFUSE_CLICKHOUSE_PASSWORD:-}

      # --- Security ---
      - NEXTAUTH_SECRET=${LANGFUSE_NEXTAUTH_SECRET}
      - SALT=${LANGFUSE_SALT}
      - NEXTAUTH_URL=${LANGFUSE_URL:-http://localhost:3050}
      - TELEMETRY_ENABLED=${LANGFUSE_TELEMETRY:-false}

      # --- Authentication ---
      - AUTH_DISABLE_USERNAME_PASSWORD=${LANGFUSE_DISABLE_PASSWORD_AUTH:-false}
      - AUTH_DISABLE_SIGNUP=${LANGFUSE_DISABLE_SIGNUP:-false}

      # --- SSO (optional) ---
      - AUTH_GOOGLE_CLIENT_ID=${LANGFUSE_GOOGLE_CLIENT_ID:-}
      - AUTH_GOOGLE_CLIENT_SECRET=${LANGFUSE_GOOGLE_CLIENT_SECRET:-}
      - AUTH_GITHUB_CLIENT_ID=${LANGFUSE_GITHUB_CLIENT_ID:-}
      - AUTH_GITHUB_CLIENT_SECRET=${LANGFUSE_GITHUB_CLIENT_SECRET:-}

      # --- S3 Storage (optional, for large traces) ---
      - LANGFUSE_S3_BUCKET_NAME=${LANGFUSE_S3_BUCKET:-}
      - LANGFUSE_S3_ENDPOINT=${LANGFUSE_S3_ENDPOINT:-}
      - LANGFUSE_S3_ACCESS_KEY_ID=${LANGFUSE_S3_ACCESS_KEY:-}
      - LANGFUSE_S3_SECRET_ACCESS_KEY=${LANGFUSE_S3_SECRET_KEY:-}
      - LANGFUSE_S3_REGION=${LANGFUSE_S3_REGION:-us-east-1}

      # --- Logging ---
      - LANGFUSE_LOG_LEVEL=${LANGFUSE_LOG_LEVEL:-info}
      - LANGFUSE_LOG_FORMAT=${LANGFUSE_LOG_FORMAT:-json}
    ports:
      - "${LANGFUSE_PORT:-3050}:3000"
    networks:
      - infra
    depends_on:
      langfuse-init:
        condition: service_completed_successfully
    deploy:
      resources:
        limits:
          cpus: "${LANGFUSE_CPU_LIMIT:-2}"
          memory: ${LANGFUSE_MEMORY_LIMIT:-2G}
        reservations:
          cpus: "0.5"
          memory: 512M
    healthcheck:
      test: ["CMD", "sh", "-c", "wget -q --spider http://$(hostname):3000/api/public/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    security_opt:
      - no-new-privileges:true
    labels:
      - "prometheus.scrape=true"
      - "prometheus.port=3000"
      - "prometheus.path=/api/public/metrics"
      - "traefik.enable=${LANGFUSE_TRAEFIK_ENABLE:-false}"
      - "traefik.http.routers.langfuse.rule=Host(`${LANGFUSE_DOMAIN:-langfuse.localhost}`)"
      - "traefik.http.routers.langfuse.entrypoints=websecure"
      - "traefik.http.routers.langfuse.tls.certresolver=letsencrypt"
      - "traefik.http.services.langfuse.loadbalancer.server.port=3000"
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ===========================================================================
  # Database Initialization (creates DB in shared postgres, then exits)
  # ===========================================================================
  langfuse-init:
    image: postgres:16-alpine
    container_name: langfuse-init
    environment:
      - PGPASSWORD=${POSTGRES_PASSWORD}
      - LANGFUSE_DB_NAME=${LANGFUSE_DB_NAME:-langfuse}
      - LANGFUSE_DB_USER=${LANGFUSE_DB_USER:-langfuse}
      - LANGFUSE_DB_PASS=${LANGFUSE_DB_PASS}
    networks:
      - infra
    entrypoint:
      - sh
      - -c
      - |
        echo "Waiting for PostgreSQL..."
        until pg_isready -h postgres -U postgres; do
          sleep 2
        done
        echo "Checking if database exists..."
        if ! psql -h postgres -U postgres -lqt | cut -d \| -f 1 | grep -qw "$$LANGFUSE_DB_NAME"; then
          echo "Creating database and user..."
          psql -h postgres -U postgres -c "CREATE USER $$LANGFUSE_DB_USER WITH PASSWORD '$$LANGFUSE_DB_PASS';" || true
          psql -h postgres -U postgres -c "CREATE DATABASE $$LANGFUSE_DB_NAME OWNER $$LANGFUSE_DB_USER;"
          psql -h postgres -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE $$LANGFUSE_DB_NAME TO $$LANGFUSE_DB_USER;"
          echo "Database created successfully"
        else
          echo "Database already exists"
        fi
    restart: "no"

  # ===========================================================================
  # LangFuse Worker (optional - enable with --profile worker)
  # For v3 or high-volume v2 setups
  # ===========================================================================
  langfuse-worker:
    image: langfuse/langfuse-worker:${LANGFUSE_VERSION:-2}
    container_name: langfuse-worker
    profiles:
      - worker
    restart: unless-stopped
    environment:
      - TZ=UTC
      - DATABASE_URL=postgresql://${LANGFUSE_DB_USER:-langfuse}:${LANGFUSE_DB_PASS}@postgres:5432/${LANGFUSE_DB_NAME:-langfuse}
      - REDIS_HOST=${LANGFUSE_REDIS_HOST:-redis-cache}
      - REDIS_PORT=${LANGFUSE_REDIS_PORT:-6379}
      - REDIS_AUTH=${LANGFUSE_REDIS_AUTH:-}
      - CLICKHOUSE_MIGRATION_URL=${LANGFUSE_CLICKHOUSE_URL:-}
      - CLICKHOUSE_URL=${LANGFUSE_CLICKHOUSE_URL:-}
      - CLICKHOUSE_USER=${LANGFUSE_CLICKHOUSE_USER:-default}
      - CLICKHOUSE_PASSWORD=${LANGFUSE_CLICKHOUSE_PASSWORD:-}
      - LANGFUSE_LOG_LEVEL=${LANGFUSE_LOG_LEVEL:-info}
    networks:
      - infra
    depends_on:
      langfuse:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "${LANGFUSE_WORKER_CPU_LIMIT:-1}"
          memory: ${LANGFUSE_WORKER_MEMORY_LIMIT:-1G}
        reservations:
          cpus: "0.25"
          memory: 256M
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

# =============================================================================
# Networks (uses shared infra network)
# =============================================================================
networks:
  infra:
    external: true
