# =============================================================================
# WireGuard VPN - Secure Remote Access
# =============================================================================
# Fast, modern VPN for secure access to your infrastructure
#
# Usage:
#   cp .env.example .env
#   nano .env  # Set SERVERURL to your server's public IP or domain
#   docker compose up -d
#
# Client configs will be generated in ./config/peer_*/
# =============================================================================

services:
  wireguard:
    image: lscr.io/linuxserver/wireguard:latest
    container_name: wireguard
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
      # Your server's public IP or domain
      - SERVERURL=${SERVERURL:-auto}
      # VPN port
      - SERVERPORT=${SERVERPORT:-51820}
      # Number of client configs to generate
      - PEERS=${PEERS:-3}
      # Peer names (comma-separated)
      - PEERDNS=${PEERDNS:-1.1.1.1,8.8.8.8}
      # Internal subnet
      - INTERNAL_SUBNET=${INTERNAL_SUBNET:-10.13.13.0}
      # Allowed IPs for clients (what traffic goes through VPN)
      - ALLOWEDIPS=${ALLOWEDIPS:-10.13.13.0/24,172.17.0.0/16}
      # Keep alive for NAT traversal
      - PERSISTENTKEEPALIVE_PEERS=${PERSISTENTKEEPALIVE:-25}
      # Log level
      - LOG_CONFS=true
    volumes:
      - ./config:/config
      - /lib/modules:/lib/modules:ro
    ports:
      - "${SERVERPORT:-51820}:51820/udp"
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 128M
        reservations:
          cpus: "0.1"
          memory: 32M
    healthcheck:
      test: ["CMD", "wg", "show"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# =============================================================================
# Notes
# =============================================================================
# After starting, find client configs in:
#   ./config/peer_1/peer_1.conf  - Import to WireGuard app
#   ./config/peer_1/peer_1.png   - QR code for mobile
#
# To add more peers later:
#   1. Increase PEERS in .env
#   2. docker compose up -d
# =============================================================================
